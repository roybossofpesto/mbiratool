<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="semantic.min.css">

    <script src="jquery.min.js" charset="utf-8"></script>
    <!-- <script src="jquery-webstorage.js" charset="utf-8"></script> -->
    <script src="semantic.min.js" charset="utf-8"></script>
    <script src="chroma.min.js" charset="utf-8"></script>
    <script src="Tone.js" charset="utf-8"></script>

    <script src="common.js" charset="utf-8"></script>
    <script src="nema.js" charset="utf-8"></script>
    <script src="NoteWidget.js" charset="utf-8"></script>
    <script src="GridWidget.js" charset="utf-8"></script>

    <title>mbira composer</title>
    <script type="text/javascript">
        "use strict";

        $().ready(() => {
            const grid = new GridWidget();
            grid.elem.appendTo('.master.container');

            Tone.Transport.bpm.value = 120;

            // const phaser = new Tone.Phaser({
            // 	"frequency" : 15,
            // 	"octaves" : 5,
            // 	"baseFrequency" : 1000
            // }).toMaster();

            const auto_panner = new Tone.AutoPanner().toMaster().start();
            auto_panner.set({
                frequency: "8n",
                type: "sine",
                depth: 0,
            });
            console.log("auto_panner", auto_panner.get());

            // const mbira_synth = new Tone.FMSynth().toMaster();
            const mbira_synth = new Tone.PolySynth(24, Tone.Synth).connect(auto_panner);
            mbira_synth.set({
                "envelope": {
                    "attack": 1e-2,
                    "attackCurve": "exponential",
                    "decay": 1.,
                    "sustain": .3,
                    "release": 1.5,
                    "releaseCurve": "ripple",
                },
                "volume": -20,
            });
            console.log("mbira_synth", mbira_synth.get());

            const mbira_loop = new Tone.Sequence((time, widget) => {
                // const transpose = transpose_coarse + transpose_fine / 100.;
                const next_note = widget.note ? widget.note.note : null;
                if (next_note) mbira_synth.triggerAttackRelease(Tone.Frequency(next_note), "16n", time);
                // if (note) mbira_synth.triggerAttackRelease(Tone.Frequency(note).transpose(transpose), "16n", time);
                Tone.Draw.schedule(() => {
                    widget.elem.find('.icon.buttons')
                        .css('margin-right', '10px')
                        .animate({
                            marginRight: 0
                        }, 300);
                }, time);
            }, grid.widgets, "8n").start();

            // Effects
            $('.effects .auto_panner').click(function() {
                const enabled = $(this).toggleClass('active').hasClass('active');
                auto_panner.set('depth', enabled ? .8 : 0);
            })

            // Tone transport
            $('.transport.buttons .start').click(() => Tone.Transport.start());
            $('.transport.buttons .pause').click(() => Tone.Transport.pause());
            $('.transport.buttons .stop').click(() => Tone.Transport.stop());
            $(document).keydown((evt) => {
                if (evt.keyCode != 32) return;
                const state = Tone.Transport.state;
                if (state == "paused" || state == "stopped") Tone.Transport.start();
                else Tone.Transport.pause();
            });

            Tone.Transport.on('start', () => {
                $('.transport.buttons .button').removeClass('active');
                $('.transport.buttons .start').addClass('active');
            });
            Tone.Transport.on('pause', () => {
                $('.transport.buttons .button').removeClass('active');
                $('.transport.buttons .pause').addClass('active');
            });
            Tone.Transport.on('stop', () => {
                $('.transport.buttons .button').removeClass('active');
                $('.transport.buttons .stop').addClass('active');
            });
        });
    </script>
    <style media="screen">
        .ui.master.container {
            padding: 3em 0;
        }
    </style>
</head>

<body>
    <div class="ui master container">
        <div class="ui compact icon transport buttons">
            <div class="ui start button"><i class="play icon"></i></div>
            <div class="ui pause button"><i class="pause icon"></i></div>
            <div class="ui stop active button"><i class="stop icon"></i></div>
        </div>
        <div class="ui compact icon effects buttons">
            <div class="ui auto_panner button"><i class="exchange icon"></i></div>
        </div>
    </div>
</body>

</html>
