<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="semantic.min.css">

    <script src="jquery.min.js" charset="utf-8"></script>
    <!-- <script src="jquery-webstorage.js" charset="utf-8"></script> -->
    <script src="semantic.min.js" charset="utf-8"></script>
    <script src="chroma.min.js" charset="utf-8"></script>
    <script src="Tone.js" charset="utf-8"></script>

    <script src="common.js" charset="utf-8"></script>
    <script src="nema.js" charset="utf-8"></script>
    <script src="NoteWidget.js" charset="utf-8"></script>
    <script src="GridWidget.js" charset="utf-8"></script>
    <script src="MbiraInstrument.js" charset="utf-8"></script>

    <title>mbira composer</title>
    <script type="text/javascript">
        "use strict";

        $().ready(() => {
            Tone.Transport.bpm.value = 60;
            console.log('transport', Tone.Transport);

            // const phaser = new Tone.Phaser({
            // 	"frequency" : 15,
            // 	"octaves" : 5,
            // 	"baseFrequency" : 1000
            // }).toMaster();

            // Effects
            const auto_wah = new Tone.AutoWah({
                baseFrequency: 50,
                wet: 0,
            }).toMaster();
            $('.effects .auto_wah').click(function() {
                const enabled = $(this).toggleClass('active').hasClass('active');
                auto_wah.wet.rampTo(enabled ? .5 : 0, .3);
            })
            console.log("auto_wah", auto_wah.get());

            const auto_panner = new Tone.AutoPanner({
                frequency: "8n",
                type: "sine",
                depth: .8,
                wet: 0,
            }).connect(auto_wah).start();
            $('.effects .auto_panner').click(function() {
                const enabled = $(this).toggleClass('active').hasClass('active');
                auto_panner.wet.rampTo(enabled ? 1 : 0, .3);
            })
            console.log("auto_panner", auto_panner.get());
            const effects = {
                auto_wah: auto_wah,
                auto_panner: auto_panner,
            };

            const mbira_aa = new MbiraInstrument(effects);
            const mbira_bb = new MbiraInstrument(effects);
            mbira_bb.grid.collapsed = true;
            // mbira_bb.grid.playing = false;
            // mbira_aa.grid.muted = true;

            /*
            const am_synth = new Tone.AMSynth().toMaster();
            const noise_synth = new Tone.NoiseSynth();
            // noise_synth.start();
            am_synth.set('modulator', noise_synth);
            am_synth.set('carrier', auto_wah);
            console.log(am_synth.get());
            */

            { // Hosho synth and loop
                const hosho_synth = new Tone.NoiseSynth({
                    noise: {
                        type: 'white',
                    },
                    envelope: {
                        attack: 1e-2,
                        decay: 2,
                        sustain: 1.,
                        release: .5,
                    },
                    volume: -20,
                }).toMaster();
                console.log("hosho_synth", hosho_synth.get());

                let hosho_beat = -1;
                const hosho_loop = new Tone.Sequence((time, index) => {
                    if (hosho_beat < 0) return;
                    // if (Math.floor(index / 2) % 3 == hosho_beat) hosho_synth.triggerAttackRelease(index % 2 == 0 ? "16n" : "4n", time);
                    // if ((index + 5) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("16n", time);
                    // if ((index + 0) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("2n", time);
                    if ((index + 0) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("64n", time);
                    if ((index + 3) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("64n", time, .2);
                    if ((index + 2) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("16n", time, .5);
                }, [...Array(6).keys()], '16t').start();

                const beat_buttons = $('.hosho.buttons .beat');
                beat_buttons.click(function() {
                    beat_buttons.removeClass('active');
                    $(this).addClass('active');
                    hosho_beat = $(this).data('value');
                });

                $('.hosho.buttons .volume.up').click(() => {
                    hosho_synth.volume.value += 3;
                });
                $('.hosho.buttons .volume.down').click(() => {
                    hosho_synth.volume.value -= 3;
                });
            }

            { // Tone transport
                $('.transport.buttons .start').click(() => Tone.Transport.start());
                $('.transport.buttons .pause').click(() => Tone.Transport.pause());
                $('.transport.buttons .stop').click(() => Tone.Transport.stop());

                /*$(document).keydown((evt) => {
                    if (evt.keyCode != 32) return;
                    const state = Tone.Transport.state;
                    if (state == "paused" || state == "stopped") Tone.Transport.start();
                    else Tone.Transport.pause();
                });*/

                Tone.Transport.on('start', () => {
                    $('.transport.buttons .button').removeClass('active');
                    $('.transport.buttons .start').addClass('active');
                });
                Tone.Transport.on('pause', () => {
                    $('.transport.buttons .button').removeClass('active');
                    $('.transport.buttons .pause').addClass('active');
                });
                Tone.Transport.on('stop', () => {
                    $('.transport.buttons .button').removeClass('active');
                    $('.transport.buttons .stop').addClass('active');
                });
            }

            { // Bpm
                const label = $('.bpm.buttons .value span');
                $('.bpm.buttons .increment').click(() => {
                    Tone.Transport.bpm.value += 10;
                    const displayed_bpm = Tone.Transport.bpm.value;
                    label.text(displayed_bpm.toFixed(0).padStart(3, '0'));
                })
                $('.bpm.buttons .decrement').click(() => {
                    Tone.Transport.bpm.value -= 10;
                    const displayed_bpm = Tone.Transport.bpm.value;
                    label.text(displayed_bpm.toFixed(0).padStart(3, '0'));
                })
            }
        });
    </script>
    <style media="screen">
        .ui.master.container {
            padding: 3em 0;
        }
    </style>
</head>

<body>
    <div class="ui master container">
        <div class="ui grid">
            <div class="eight wide column">
                <div class="ui bpm icon buttons">
                    <div class="ui decrement button"><i class="minus icon"></i></div>
                    <div class="ui value button dropdown"><span>060</span>
                        <div class="menu">
                            <div class="set_chords_633 item">Pattern 633</div>
                            <div class="set_chords_444 item">Pattern 444</div>
                            <div class="divider"></div>
                            <div class="increment_chords item">Transpose +</div>
                            <div class="decrement_chords item">Transpose -</div>
                        </div>
                    </div>
                    <div class="ui increment button"><i class="plus icon"></i></div>
                </div>
                <div class="ui icon transport buttons">
                    <div class="ui start button"><i class="play icon"></i></div>
                    <div class="ui pause button"><i class="pause icon"></i></div>
                    <div class="ui stop active button"><i class="stop icon"></i></div>
                </div>
            </div>
            <div class="eight wide right aligned column">
                <div class="ui icon hosho buttons">
                    <div class="ui active none beat button" data-value='-1'><i class="volume off icon"></i></div>
                    <div class="ui first beat button" data-value='0'>1</div>
                    <div class="ui second beat button" data-value='1'>2</div>
                    <div class="ui third beat button" data-value='2'>3</div>
                    <div class="ui volume down button"><i class="icon volume down"></i></div>
                    <div class="ui volume up button"><i class="icon volume up"></i></div>
                </div>
                <div class="ui icon effects buttons">
                    <div class="ui auto_panner button"><i class="exchange icon"></i></div>
                    <div class="ui auto_wah button"><i class="mercury icon"></i></div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
