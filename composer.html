<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="semantic.min.css">

    <script src="jquery.min.js" charset="utf-8"></script>
    <!-- <script src="jquery-webstorage.js" charset="utf-8"></script> -->
    <script src="semantic.min.js" charset="utf-8"></script>
    <script src="chroma.min.js" charset="utf-8"></script>
    <script src="Tone.js" charset="utf-8"></script>

    <script src="common.js" charset="utf-8"></script>
    <script src="nema.js" charset="utf-8"></script>
    <script src="NoteWidget.js" charset="utf-8"></script>
    <script src="GridWidget.js" charset="utf-8"></script>

    <title>mbira composer</title>
    <script type="text/javascript">
        "use strict";

        $().ready(() => {
            const grid = new GridWidget();
            grid.elem.appendTo('.master.container');

            Tone.Transport.bpm.value = 120;
            Tone.Transport.timeSignature = 4;
            console.log('transport', Tone.Transport);

            // const phaser = new Tone.Phaser({
            // 	"frequency" : 15,
            // 	"octaves" : 5,
            // 	"baseFrequency" : 1000
            // }).toMaster();

            // Effects
            const auto_wah = new Tone.AutoWah({
                baseFrequency: 50,
                wet: 0,
            }).toMaster();
            $('.effects .auto_wah').click(function() {
                const enabled = $(this).toggleClass('active').hasClass('active');
                auto_wah.wet.rampTo(enabled ? .5 : 0, .3);
            })
            console.log("auto_wah", auto_wah.get());

            const auto_panner = new Tone.AutoPanner({
                frequency: "8n",
                type: "sine",
                depth: .8,
                wet: 0,
            }).connect(auto_wah).start();
            $('.effects .auto_panner').click(function() {
                const enabled = $(this).toggleClass('active').hasClass('active');
                auto_panner.wet.rampTo(enabled ? 1 : 0, .3);
            })
            console.log("auto_panner", auto_panner.get());

            { // Mbira synth & loop
                const mbira_synth = new Tone.PolySynth(24, Tone.Synth).connect(auto_panner);
                mbira_synth.set({
                    envelope: {
                        attack: 1e-2,
                        attackCurve: "exponential",
                        decay: 1.,
                        sustain: .3,
                        release: 1.5,
                        releaseCurve: "ripple",
                    },
                    volume: -20,
                });
                console.log("mbira_synth", mbira_synth.get());

                const mbira_loop = new Tone.Sequence((time, widget) => {
                    // const transpose = transpose_coarse + transpose_fine / 100.;
                    const next_note = widget.note ? widget.note.note : null;
                    if (next_note) mbira_synth.triggerAttackRelease(Tone.Frequency(next_note), "16n", time);
                    // if (note) mbira_synth.triggerAttackRelease(Tone.Frequency(note).transpose(transpose), "16n", time);
                    Tone.Draw.schedule(() => {
                        widget.elem.find('.icon.buttons')
                            .css('margin-right', '10px')
                            .animate({
                                marginRight: 0
                            }, 300);
                    }, time);
                }, grid.widgets, "4t").start();
            }

            { // Hosho synth and loop
                const hosho_synth = new Tone.NoiseSynth({
                    noise: {
                        type: 'white',
                    },
                    envelope: {
                        attack: 1e-2,
                        decay: 0.4,
                        sustain: .1,
                        release: .2,
                    },
                    volume: -13,
                }).toMaster();
                console.log("hosho_synth", hosho_synth.get());

                let hosho_beat = -1;
                const hosho_loop = new Tone.Sequence((time, index) => {
                    if (hosho_beat < 0) return;
                    // if (Math.floor(index / 2) % 3 == hosho_beat) hosho_synth.triggerAttackRelease(index % 2 == 0 ? "16n" : "4n", time);
                    // if ((index + 5) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("16n", time);
                    // if ((index + 0) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("2n", time);
                    if ((index + 0) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("64n", time);
                    if ((index + 3) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("64n", time, .5);
                    if ((index + 4) % 6 == 2 * hosho_beat) hosho_synth.triggerAttackRelease("64n", time, .5);
                }, [...Array(6).keys()], '8t').start();

                const beat_buttons = $('.hosho.buttons .beat');
                beat_buttons.click(function() {
                    beat_buttons.removeClass('active');
                    $(this).addClass('active');
                    hosho_beat = $(this).data('value');
                });

                $('.hosho.buttons .volume.up').click(() => {
                    hosho_synth.volume.value += 3;
                });
                $('.hosho.buttons .volume.down').click(() => {
                    hosho_synth.volume.value -= 3;
                });
            }

            { // Tone transport
                $('.transport.buttons .start').click(() => Tone.Transport.start());
                $('.transport.buttons .pause').click(() => Tone.Transport.pause());
                $('.transport.buttons .stop').click(() => Tone.Transport.stop());

                /*$(document).keydown((evt) => {
                    if (evt.keyCode != 32) return;
                    const state = Tone.Transport.state;
                    if (state == "paused" || state == "stopped") Tone.Transport.start();
                    else Tone.Transport.pause();
                });*/

                Tone.Transport.on('start', () => {
                    $('.transport.buttons .button').removeClass('active');
                    $('.transport.buttons .start').addClass('active');
                });
                Tone.Transport.on('pause', () => {
                    $('.transport.buttons .button').removeClass('active');
                    $('.transport.buttons .pause').addClass('active');
                });
                Tone.Transport.on('stop', () => {
                    $('.transport.buttons .button').removeClass('active');
                    $('.transport.buttons .stop').addClass('active');
                });
            }

            { // Bpm
                const label = $('.bpm.buttons .value span');
                // $('.bpm.buttons .increment').click(() => {
                //     Tone.Transport.bpm.value += 10;
                //     label.text(Tone.Transport.bpm.value.toFixed(0));
                // })
                $('.bpm.buttons .decrement').click(() => {
                    Tone.Transport.bpm.value -= 10;
                    label.text(Tone.Transport.bpm.value.toFixed(0).padStart(3, '0'));
                })
            }
        });
    </script>
    <style media="screen">
        .ui.master.container {
            padding: 3em 0;
        }
    </style>
</head>

<body>
    <div class="ui master container">
        <div class="ui grid">
            <div class="four wide column">
                <div class="ui bpm icon buttons">
                    <div class="ui decrement button"><i class="minus icon"></i></div>
                    <div class="ui value button dropdown"><span>120</span>
                        <div class="menu">
                            <div class="set_chords_633 item">Pattern 633</div>
                            <div class="set_chords_444 item">Pattern 444</div>
                            <div class="divider"></div>
                            <div class="increment_chords item">Transpose +</div>
                            <div class="decrement_chords item">Transpose -</div>
                        </div>
                    </div>
                    <div class="ui increment button"><i class="plus icon"></i></div>
                </div>
            </div>
            <div class="twelve wide column">
                <div class="ui icon transport buttons">
                    <div class="ui start button"><i class="play icon"></i></div>
                    <div class="ui pause button"><i class="pause icon"></i></div>
                    <div class="ui stop active button"><i class="stop icon"></i></div>
                </div>
                <div class="ui icon effects buttons">
                    <div class="ui auto_panner button"><i class="exchange icon"></i></div>
                    <div class="ui auto_wah button"><i class="mercury icon"></i></div>
                </div>
                <div class="ui icon hosho buttons">
                    <div class="ui active none beat button" data-value='-1'>&emptyset;</div>
                    <div class="ui first beat button" data-value='0'>1</div>
                    <div class="ui second beat button" data-value='1'>2</div>
                    <div class="ui third beat button" data-value='2'>3</div>
                    <div class="ui volume down button"><i class="icon volume down"></i></div>
                    <div class="ui volume up button"><i class="icon volume up"></i></div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
